---
layout: post
title: Linux-Windows Single Sign-On
date: 2009-03-17
comments: false
---


<div class='post'>
    Here I'm going to post very useful Linux-Windows Single Sign-On configuration, for who wants to authenticate their
    linux Machines over the Active Directory. <p style="margin-bottom: 0in;">Setup and Configure Winbind</p>
    <ul>
        <li><p style="margin-bottom: 0in;"><a name="intelliTXT2"></a><i>Name Service Switch (NSS): </i>This is a set of
            capabilities built into the Linux C libraries that allow an application to select a source to validate
            authentication credentials. </p></li>
        <li><p style="margin-bottom: 0in;"><i>Pluggable Authentication Modules (PAM):</i> This extends the standard Unix
            password authentication mechanism to include central authentication databases such as LDAP, Kerberos, AD and
            so on. </p></li>
        <li><p style="margin-bottom: 0in;"><i>Winbind with Samba:</i> The winbind service uses Samba for configuration
            information. For AD interoperability, make sure your system is running a current version of Samba (3.05 or
            newer). </p></li>
        <li><p><i>Kerberos:</i> Winbind uses Kerberos to get tickets for accessing AD. A Windows domain controller acts
            as the Key Distribution Center (KDC). </p></li>
    </ul>
    <p style="margin-bottom: 0in;"><br/></p>
    <ol>
        <li><p style="margin-bottom: 0in;">To configure winbind in Centos, launch the <strong>Authentication
            Configuration</strong> (as superuser (root). System-config-authentication but it doesn't make all the
            required configuration settings.</p></li>
        <li><p style="margin-bottom: 0in;">Check the Use Winbind option</p></li>
        <li>In the <strong>Winbind Settings</strong> window, set the <em>Security Model</em> to <em>ads</em> and fill in
            the <em>Winbind Domain</em>, <em>Winbind ADS Realm</em> and <em>Winbind Domain Controllers</em>. See sample
            settings below.
        </li>
    </ol>
    <p style="margin-bottom: 0in;"><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}"
                                      href="http://2.bp.blogspot.com/__QKi18hqWqc/ScBmjDyf_mI/AAAAAAAAABg/wOI494SsiYU/s1600-h/Screenshot-Winbind+Settings.png"><img
            style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer; width: 320px; height: 266px;"
            src="http://2.bp.blogspot.com/__QKi18hqWqc/ScBmjDyf_mI/AAAAAAAAABg/wOI494SsiYU/s320/Screenshot-Winbind+Settings.png"
            alt="" id="BLOGGER_PHOTO_ID_5314360312795758178" border="0"/></a></p>

    <p style="margin-bottom: 0in;"></p>

    <p style="margin-bottom: 0in;"><br/></p>
    <ul>
        <li><p style="margin-bottom: 0in;">Domain: flat (NetBIOS) name for the domain (COMPANY) </p></li>
        <li><p style="margin-bottom: 0in;">Security Model: ADS </p></li>
        <li><p style="margin-bottom: 0in;">ADS Realm: FQDN for the domain (company.com) </p></li>
        <li><p style="margin-bottom: 0in;">Domain Controllers: Fully Qualified Domain Name (FQDN) for a domain
            controller (dc1.company.com) </p></li>
        <li><p>Template Shell: /bin/bash </p></li>
    </ul>
    <p><br/></p>

    <p><a name="intelliTXT"></a>There's a Join Domain option, but don't select it. It might not work, and you won't get
        sufficient feedback to help resolve problems. For now, just click OK to save the changes you just entered.</p>

    <p><br/></p>

    <p>NOTE: </p>

    <p>To ensure the success of the Active Directory integration, make sure that your Active Directory DNS is working,
        you are using the Active Directory DNS, you can ping the domain controllers and that the difference between the
        domain controllers’ clock is not more than five minutes.</p>

    <p><br/></p>

    <p><a name="intelliTXT1"></a>When the authconfig window closes, the console window should show that winbind starts.
        If this fails, try starting the service manually with the following command:</p>

    <p>/etc/init.d/winbind start</p>

    <p>If winbind starts, it will appear on a ps process list like this:</p>

    <p># ps -A | grep winbind<br/>3132 ? 00:00:00 winbindd<br/>3133 ? 00:00:00 winbindd</p>

    <p><br/><br/></p> <a name="intelliTXT3"></a> 4. Configuration Files<p style="margin-bottom: 0in;">Authconfig makes
    changes to three configuration files. </p>
    <ul>
        <li><p style="margin-bottom: 0in;"><i>nsswitch (/etc/nsswitch.conf): The critical entries are passwd and group.
            Other Linux flavors don't bother assigning winbind to other services</i></p>

            <p style="margin-bottom: 0in;"><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}"
                                              href="http://3.bp.blogspot.com/__QKi18hqWqc/ScBnjtuSOsI/AAAAAAAAABo/XmFPVDn6bSk/s1600-h/Screenshotgedit.png"><img
                    style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer; width: 320px; height: 260px;"
                    src="http://3.bp.blogspot.com/__QKi18hqWqc/ScBnjtuSOsI/AAAAAAAAABo/XmFPVDn6bSk/s320/Screenshotgedit.png"
                    alt="" id="BLOGGER_PHOTO_ID_5314361423563995842" border="0"/></a></p></li>
    </ul>
    <p style="margin-bottom: 0in;"></p>

    <p style="margin-bottom: 0in;"><a name="intelliTXT4"></a><i> (nsswitch (/etc/nsswitch.conf) - comments and
        irrelevant information removed</i></p>

    <p style="margin-bottom: 0in;"><br/></p>

    <p style="margin-bottom: 0in;"><i>passwd: files winbind </i></p>

    <p style="margin-bottom: 0in;"><i>shadow: files winbind </i></p>

    <p style="margin-bottom: 0in;"><i>group: files winbind </i></p>

    <p style="margin-bottom: 0in;"><i> hosts: files dns </i></p>

    <p style="margin-bottom: 0in;"><i>bootparams: nisplus [NOTFOUND=return] files </i></p>

    <p style="margin-bottom: 0in;"><i>ethers: files </i></p>

    <p style="margin-bottom: 0in;"><i>netmasks: files </i></p>

    <p style="margin-bottom: 0in;"><i>networks: files </i></p>

    <p style="margin-bottom: 0in;"><i>protocols: files </i></p>

    <p style="margin-bottom: 0in;"><i>rpc: files </i></p>

    <p style="margin-bottom: 0in;"><i>services: files </i></p>

    <p style="margin-bottom: 0in;"><i>netgroup: files </i></p>

    <p style="margin-bottom: 0in;"><i>publickey: nisplus </i></p>

    <p style="margin-bottom: 0in;"><i> automount: files </i></p>

    <p style="margin-bottom: 0in;"><i>aliases: files nisplus</i></p>

    <p style="margin-bottom: 0in;"><br/></p>

    <p style="margin-bottom: 0in;"><br/></p>
    <ul>
        <li><p style="margin-bottom: 0in;"><i>system-auth (/etc/pam.d/system-auth):</i> PAM uses a stackable
            authentication scheme, and each element in the stack must be separately configured. </p></li>
    </ul>
    <p style="margin-bottom: 0in;"><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}"
                                      href="http://4.bp.blogspot.com/__QKi18hqWqc/ScBnj0im4BI/AAAAAAAAABw/9ea1q-jJ4Gw/s1600-h/Screenshot-sys-auth-gedit.png"><img
            style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer; width: 320px; height: 260px;"
            src="http://4.bp.blogspot.com/__QKi18hqWqc/ScBnj0im4BI/AAAAAAAAABw/9ea1q-jJ4Gw/s320/Screenshot-sys-auth-gedit.png"
            alt="" id="BLOGGER_PHOTO_ID_5314361425394065426" border="0"/></a> <i>system-auth
        (/etc/pam.d/system-auth)</i></p>

    <p style="margin-bottom: 0in;"><br/></p>

    <p style="margin-bottom: 0in;"><i>#%PAM-1.0 </i></p>

    <p style="margin-bottom: 0in;"><i># This file is auto-generated. </i></p>

    <p style="margin-bottom: 0in;"><i># User changes will be destroyed the next time authconfig is run. </i></p>

    <p style="margin-bottom: 0in;"><i>auth required /lib/security/$ISA/pam_env.so </i></p>

    <p style="margin-bottom: 0in;"><i>auth sufficient /lib/security/$ISA/pam_unix.so likeauth nullok </i></p>

    <p style="margin-bottom: 0in;"><i>auth sufficient /lib/security/$ISA/pam_winbind.so use_first_pass </i></p>

    <p style="margin-bottom: 0in;"><i>auth required /lib/security/$ISA/pam_deny.so </i></p>

    <p style="margin-bottom: 0in;"><i>account sufficient /lib/security/$ISA/pam_succeed_if.so uid <></i></p><i> </i>

    <p style="margin-bottom: 0in;"><i><i>account required /lib/security/$ISA/pam_unix.so </i></i></p><i> </i>

    <p style="margin-bottom: 0in;"><i><i>account [default=bad success=ok user_unknown=ignore]
        /lib/security/$ISA/pam_winbind.so </i></i></p><i> </i>

    <p style="margin-bottom: 0in;"><i><i>password requisite /lib/security/$ISA/pam_cracklib.so retry=3 </i></i></p>
    <i> </i>

    <p style="margin-bottom: 0in;"><i><i>password sufficient /lib/security/$ISA/pam_unix.so nullok use_authtok md5
        shadow </i></i></p><i> </i>

    <p style="margin-bottom: 0in;"><i><i>password sufficient /lib/security/$ISA/pam_winbind.so use_authtok </i></i></p>
    <i> </i>

    <p style="margin-bottom: 0in;"><i><i>password required /lib/security/$ISA/pam_deny.so </i></i></p><i> </i>

    <p style="margin-bottom: 0in;"><i><i>session required /lib/security/$ISA/pam_limits.so </i></i></p><i> </i>

    <p style="margin-bottom: 0in;"><i><i>session required /lib/security/$ISA/pam_unix.so </i> </i></p><i> </i>
    <ul>
        <li><p style="margin-bottom: 0in;"><i> <i>smb.conf (/etc/samba/smb.conf):</i> The idmap entries are important
            because winbind uses them to maintain a correspondence between AD account names and the User IDs and Group
            IDs used by Linux. Fedora assigns a large range of potential IDs. Typically, other Linux flavors assign a
            range of 10000-20000. </i></p><i> </i></li>
    </ul>
    <i> </i>

    <p style="margin-bottom: 0in;"><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}"
                                      href="http://1.bp.blogspot.com/__QKi18hqWqc/ScBpViPgEoI/AAAAAAAAACI/GQEbpAQojf8/s1600-h/Screenshot--smb+-+gedit.png"><img
            style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer; width: 320px; height: 274px;"
            src="http://1.bp.blogspot.com/__QKi18hqWqc/ScBpViPgEoI/AAAAAAAAACI/GQEbpAQojf8/s320/Screenshot--smb+-+gedit.png"
            alt="" id="BLOGGER_PHOTO_ID_5314363378987176578" border="0"/></a></p><i> </i>

    <p style="margin-bottom: 0in;"><i> <i>smb.conf (/etc/samba/smb.conf)</i></i></p><i> </i>

    <p style="margin-bottom: 0in;"><i><br/></i></p><i> </i>

    <p style="margin-bottom: 0in;"><i>[global] </i></p><i> </i>

    <p style="margin-bottom: 0in;"><i>workgroup = COMPANY </i></p><i> </i>

    <p style="margin-bottom: 0in;"><i>server string = Samba Server </i></p><i> </i>

    <p style="margin-bottom: 0in;"><i>printcap name = /etc/printcap </i></p><i> </i>

    <p style="margin-bottom: 0in;"><i>load printers = yes </i></p><i> </i>

    <p style="margin-bottom: 0in;"><i>log file = /var/log/samba/%m.log </i></p><i> </i>

    <p style="margin-bottom: 0in;"><i>max log size = 50 </i></p><i> </i>

    <p style="margin-bottom: 0in;"><i>security = ads </i></p><i> </i>

    <p style="margin-bottom: 0in;"><i>socket options = TCP_NODELAY SO_RCVBUF=8192 SO_SNDBUF=8192 </i></p><i> </i>

    <p style="margin-bottom: 0in;"><i>dns proxy = no </i></p><i> </i>

    <p style="margin-bottom: 0in;"><i>idmap uid = 16777216-33554431 </i></p><i> </i>

    <p style="margin-bottom: 0in;"><i>idmap gid = 16777216-33554431 </i></p><i> </i>

    <p style="margin-bottom: 0in;"><i>template shell = /bin/bash </i></p><i> </i>

    <p style="margin-bottom: 0in;"><i>winbind use default domain = yes </i></p><i> </i>

    <p style="margin-bottom: 0in;"><i>password server = dc1.company.com </i></p><i> </i>

    <p style="margin-bottom: 0in;"><i>realm = COMPANY.COM </i></p><i> </i>

    <p style="margin-bottom: 0in;"><i><a name="intelliTXT5"></a>Also, in smb.conf, note the home directory path inserted
        by authconfig, <i>/home/%D/%U</i>. A user, call him winuser1, from an AD domain, call it company.com, would get
        a home directory path of <i>/home/COMPANY/ winuser</i>. Authconfig does <i>not</i> create the domain folder
        under <i>/home</i>. You must create it manually. </i></p><i> </i>
    <ul>
        <li><i>krb5 (/etc/krb5.conf):</i> Krb5 issue tickets for authenticat again AD<br/></li>
    </ul>
    <p style="margin-bottom: 0in;"><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}"
                                      href="http://1.bp.blogspot.com/__QKi18hqWqc/ScBua6s73FI/AAAAAAAAACg/OrrBVHsqWnU/s1600-h/Screenshot-krb5..png"><img
            style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer; width: 309px; height: 320px;"
            src="http://1.bp.blogspot.com/__QKi18hqWqc/ScBua6s73FI/AAAAAAAAACg/OrrBVHsqWnU/s320/Screenshot-krb5..png"
            alt="" id="BLOGGER_PHOTO_ID_5314368969010568274" border="0"/></a></p>

    <p style="margin-bottom: 0in;"><i> krb5 (/etc/krb5.conf)</i></p>

    <p style="margin-bottom: 0in; font-style: italic;">[logging]<br/>default = FILE:/var/log/krb5libs.log<br/>kdc =
        FILE:/var/log/krb5kdc.log<br/>admin_server = FILE:/var/log/kadmind.log<br/><br/>[libdefaults]<br/>default_realm
        = COMPANY.COM<br/>dns_lookup_realm = false<br/>dns_lookup_kdc = false<br/>ticket_lifetime = 24h<br/>forwardable
        = yes<br/><br/>[realms]<br/>DC1.COMPANY.COM = {<br/>kdc = kerberos.DC1.COMPANY.COM :88<br/>kdc =
        kerberos.DC1.COMPANY.COM<br/>admin_server = kerberos.DC1.COMPANY.COM:749<br/>default_domain =
        DC1.COMPANY.COM<br/>}<br/><br/>COMPANY.COM = {<br/>kdc = DC1.COMPANY.COM<br/>}<br/><br/>[domain_realm]<br/>.dc1.Company.com
        = DC1.COMPANY.COM<br/>dc1.Company.com = DC1.COMPANY.COM<br/><br/>dc1.company.com = DC1.COMPANY.COM<br/>.dc1.company.com
        = DC1.COMPANY.COM<br/>[kdc]<br/>profile = /var/kerberos/krb5kdc/kdc.conf<br/><br/>[appdefaults]<br/>pam = {<br/>debug
        = false<br/>ticket_lifetime = 36000<br/>renew_lifetime = 36000<br/>forwardable = true<br/>krb4_convert =
        false<br/>}<br/><br/></p><i> </i>

    <p><i><a name="intelliTXT6"></a><span style="font-weight: bold;">Joining an AD Domain</span> </i></p><i> </i>

    <p><i><br/>You can now join the Linux workstation to the AD domain using the Linux net command. Here's the syntax,
        with everything after the first line generated by <i>net</i>:</i></p><i> </i>

    <p><i># net ads join -U administrator<br/>administrator's password:<br/>Using short domain name -- COMPANY<br/>Joined
        'Your Machine Name' to realm 'COMPANY.COM'</i></p><i> </i>

    <p><i><br/><br/></i></p><i> </i>

    <p><i><a name="intelliTXT7"></a>Configure PAM<br/>At this point, a Windows user trying to authenticate at the Linux
        desktop would get a series of errors because a local home directory isn't present. A PAM
        module—mkhomedir.so—automatically creates a home directory. To include this module as part of the login process,
        change two configuration files under <i>/etc/pam.d</i> :</i></p><i> </i>
    <ul>
        <li><p style="margin-bottom: 0in;"><i><i>login:</i> This file controls authentication from a console prompt.
        </i></p></li>
    </ul>
    <a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}"
       href="http://4.bp.blogspot.com/__QKi18hqWqc/ScBpW-waO2I/AAAAAAAAACQ/P4tRCAnm9eQ/s1600-h/Screenshot-login+-+gedit.png"><img
            style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer; width: 320px; height: 178px;"
            src="http://4.bp.blogspot.com/__QKi18hqWqc/ScBpW-waO2I/AAAAAAAAACQ/P4tRCAnm9eQ/s320/Screenshot-login+-+gedit.png"
            alt="" id="BLOGGER_PHOTO_ID_5314363403821267810" border="0"/></a><i> </i>

    <p style="margin-bottom: 0in;"><i> </i></p><i> </i>

    <p style="margin-bottom: 0in;"><i> <i>login (/etc/pam.d/login)</i></i></p><i> </i>

    <p style="margin-bottom: 0in;"><i>#%PAM-1.0<br/>auth required pam_securetty.so<br/>auth required pam_stack.so
        service=system-auth<br/>auth required pam_nologin.so<br/>account required pam_stack.so service=system-auth<br/>password
        required pam_stack.so service=system-auth<br/>session required pam_selinux.so multiple<br/>session required
        pam_stack.so service=system-auth<br/>session optional pam_console.so<br/>session required pam_mkhomedir.so
        skel=/etc/skel/ umask=0077</i></p><i> </i>

    <p style="margin-bottom: 0in;"><i><br/></i></p><i> </i>
    <ul>
        <li><p><i><i>gdm:</i> This file controls login from a graphical screen. </i></p><i> </i></li>
    </ul>
    <i> </i><i> </i>

    <p><i><br/></i><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}"
                      href="http://2.bp.blogspot.com/__QKi18hqWqc/ScBpXCdHrsI/AAAAAAAAACY/E8nPDD1wpqc/s1600-h/Screenshot-gdm1+-+gedit.png"><img
            style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer; width: 320px; height: 178px;"
            src="http://2.bp.blogspot.com/__QKi18hqWqc/ScBpXCdHrsI/AAAAAAAAACY/E8nPDD1wpqc/s320/Screenshot-gdm1+-+gedit.png"
            alt="" id="BLOGGER_PHOTO_ID_5314363404814102210" border="0"/></a> <i><i>gdm ((/etc/pam.d/gdm)</i></i></p>
    <i> </i>

    <p><i>#%PAM-1.0<br/>auth required pam_env.so<br/>auth required pam_stack.so service=system-auth<br/>auth required
        pam_nologin.so<br/>account required pam_stack.so service=system-auth<br/>password required pam_stack.so
        service=system-auth<br/>session required pam_stack.so service=system-auth<br/>session optional
        pam_console.so<br/>session required pam_mkhomedir.so skel=/etc/skel/ umask=0077 </i></p><i> </i>

    <p><i><br/><br/></i></p><i> </i>

    <p style="margin-bottom: 0in;"><i><a name="intelliTXT8"></a>After changing the PAM files, restart the desktop. This
        is a quick way to ensure that authconfig made the correct boot settings for the required services. </i></p>
    <i> </i>

    <p style="margin-bottom: 0in;"><i><br/></i></p>
    <i> </i><i> </i><i> </i><i> </i><i> </i><i> </i><i> </i><i> </i><i> </i><i> </i><i> </i><i> </i><i> </i><i> </i><i> </i><i> </i><i> </i>

    <p style="margin-bottom: 0in;"><i>Thats all, now you can login in to your machine with AD login information.</i></p>
    <i> </i></div>
<h2>Comments</h2>
<div class='comments'>
    <div class='comment'>
        <div class='author'>Anonymous</div>
        <div class='content'>
            this post is very usefull thx!
        </div>
    </div>
</div>
