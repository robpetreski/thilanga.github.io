---
layout: post
title: Pressflow 6 with mysql Replication
date: 2011-06-27
comments: false
---


<div class='post'>
    Pressflow6 should support database replication&nbsp;according&nbsp;to the<a
        href="https://wiki.fourkitchens.com/display/PF/Using+database+replication+with+Pressflow+5+and+6"> pressflow
    wiki</a>. but when I configured master and slave, pressflow instance&nbsp;always&nbsp;pick master. If master was
    down, site&nbsp;couldn't&nbsp;load and site redirected to the&nbsp;site-offline error page.<br/><br/>I did some
    modifications in database.inc, database.mysqli.inc and settings.php&nbsp;in order to work when master mysql server
    was down.<br/><br/><b><u>Scenario</u></b><br/><br/>
    <ol>
        <li>If mysql master is inactive, connect to Slave,</li>
        <li>if slave is inactive but Master is active, then connect to Master</li>
        <li>if Master and Slave both are inactive, Redirect user to Offline page</li>
    </ol>
    <b><u><br/></u></b><br/><b><u>Modifications can be found in red text.</u></b><br/>

    <div><b><u><br/></u></b></div>
    <br/><b>database.inc</b><br/><br/>
    <ol>
        <li>Below change will modify the db_connect call to Master instance by passing 2nd parameter ("master") and by&nbsp;assigning&nbsp;$db_slave_conns[$name]
            values to&nbsp;$active_db.
        </li>
        <li>Validate before slave connection create. If master is active we are not calling Slave by adding&nbsp;$db_conns[$name]-&gt;connect_errno
            &gt; 0&nbsp;</li>
    </ol>
    <code></code><br/><code><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">function db_set_active($name = 'default') {</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; global $db_url, $db_slave_url, $db_type, $active_db, $active_slave_db;</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; static $db_conns, $db_slave_conns, $active_name = FALSE;</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;"><br/></span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; if (empty($db_url)) {</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; include_once 'includes/install.inc';</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; install_goto('install.php');</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; }</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;"><br/></span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; if (!isset($db_conns[$name])) {</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; // Initiate a new connection, using the named DB URL specified.</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; if (is_array($db_url)) {</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; $connect_url = array_key_exists($name, $db_url) ? $db_url[$name] : $db_url['default'];</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; if (is_array($db_slave_url[$name])) {</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; $slave_index = mt_rand(0, count($db_slave_url[$name]) - 1);</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; $slave_connect_url = $db_slave_url[$name][$slave_index];</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; }</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; else {</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; $slave_connect_url = $db_slave_url[$name]; &nbsp; &nbsp; &nbsp; &nbsp;</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; }</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; }</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; else {</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; $connect_url = $db_url;</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; if (is_array($db_slave_url)) {</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; $slave_index = mt_rand(0, count($db_slave_url) - 1);</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; $slave_connect_url = $db_slave_url[$slave_index];</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; }</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; else {</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; $slave_connect_url = $db_slave_url; &nbsp; &nbsp; &nbsp; &nbsp;</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; }</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; }</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;"><br/></span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; $db_type = substr($connect_url, 0, strpos($connect_url, '://'));</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; $handler = "./includes/database.$db_type.inc";</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;"><br/></span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; if (is_file($handler)) {</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; include_once $handler;</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; }</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; else {</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; _db_error_page("The database type '". $db_type ."' is unsupported. Please use either 'mysql' or 'mysqli' for MySQL, or 'pgsql' for PostgreSQL databases.");</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; }</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;"><br/></span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp;<span
        class="Apple-style-span" style="color: red;"><b> $db_conns[$name] =
    db_connect($connect_url,'master');</b></span></span></code><br/><code><span class="Apple-style-span"
                                                                                style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; if (<span
        class="Apple-style-span" style="color: red;"><b>$db_conns[$name]-&gt;connect_errno &gt; 0 &amp;&amp;</b></span>&nbsp;!empty($slave_connect_url)) {</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; $db_slave_conns[$name] = db_connect($slave_connect_url);&nbsp;</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; }</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; }</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;"><br/></span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; $previous_name = $active_name;</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; // Set the active connection.</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; $active_name = $name;</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; $active_db = $db_conns[$name];</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; if (isset($db_slave_conns[$name])) {</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; $active_slave_db = $db_slave_conns[$name];</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp;<b><span
        class="Apple-style-span"
        style="color: red;"> $active_db = $db_slave_conns[$name]; &nbsp;</span></b> &nbsp;</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; }</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; else {</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; unset($active_slave_db);</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; }</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;"><br/></span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; return $previous_name;</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">}</span></code><br/><br/><br/><a
        name='more'></a><br/><br/><b>database.mysqli.inc</b><br/>
    <ol>
        <li>db_connect function accept a 2nd parameter.&nbsp;default value will be slave</li>
        <li>wrapped&nbsp;_db_error_page(mysqli_connect_error()) with slave server validation. this will stop error page
            redirection if master server is down.
        </li>
        <li>wrapped with else block to void calling&nbsp;mysqli_query with&nbsp;uninitiated mysql resource.&nbsp;</li>
    </ol>
    <code></code><br/><code><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">function db_connect($url,<b><span
        class="Apple-style-span" style="color: red;">$server='slave'</span></b>) {</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; // Check if MySQLi support is present in PHP</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; if (!function_exists('mysqli_init') &amp;&amp; !extension_loaded('mysqli')) {</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; _db_error_page('Unable to use the MySQLi database because the MySQLi extension for PHP is not installed. Check your <code>php.ini</code> to see how you can enable it.');</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; }</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;"><br/></span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; $url = parse_url($url);</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;"><br/></span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; // Decode url-encoded information in the db connection string</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; $url['user'] = urldecode($url['user']);</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; // Test if database url has a password.</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; $url['pass'] = isset($url['pass']) ? urldecode($url['pass']) : '';</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; $url['host'] = urldecode($url['host']);</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; $url['path'] = urldecode($url['path']);</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; if (!isset($url['port'])) {</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; $url['port'] = NULL;</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; }</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;"><br/></span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; $connection = mysqli_init();</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; @mysqli_real_connect($connection, $url['host'], $url['user'], $url['pass'], substr($url['path'], 1), $url['port'], NULL, MYSQLI_CLIENT_FOUND_ROWS);</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;"><br/></span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; if (mysqli_connect_errno() &gt; 0) {</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp;<b><span
        class="Apple-style-span" style="color: red;"> if($server == 'slave'){</span></b></span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp;<span
        class="Apple-tab-span"
        style="white-space: pre;"> </span>_db_error_page(mysqli_connect_error());</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp;<b><span
        class="Apple-style-span" style="color: red;"> }</span></b></span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; <span
        class="Apple-style-span" style="color: red;"><b>}else {</b></span></span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;"><br/></span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><span class="Apple-tab-span"
                                                                                               style="white-space: pre;"> </span> &nbsp;// Force UTF-8.</span></code><br/><code><span
        class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><span class="Apple-tab-span"
                                                                                               style="white-space: pre;"> </span> &nbsp;mysqli_query($connection, 'SET NAMES "utf8"');</span></code><br/><code><b><span
        class="Apple-style-span" style="color: red; font-family: 'Courier New', Courier, monospace;">&nbsp; }</span></b></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">&nbsp; return $connection;</span></code><br/><code><span
        class="Apple-style-span"
        style="font-family: 'Courier New', Courier, monospace;">}</span></code><br/><br/><br/><b><br/></b><br/><b>settings.php</b><br/><b><br/></b><br/><b><span
        class="Apple-style-span" style="font-weight: normal;"><code></code></span></b><br/><code><span
        class="Apple-style-span"
        style="color: red; font-family: 'Courier New', Courier, monospace;">$db_url = array();</span></code><br/><code><span
        class="Apple-style-span" style="color: red; font-family: 'Courier New', Courier, monospace;">$db_url['default'] = 'mysqli://user:password@master-host/database';</span></code><br/><code><span
        class="Apple-style-span" style="color: red; font-family: 'Courier New', Courier, monospace;"><br/></span></code><br/><code><span
        class="Apple-style-span" style="color: red; font-family: 'Courier New', Courier, monospace;">$db_slave_url = array();</span></code><br/><code><span
        class="Apple-style-span" style="color: red; font-family: 'Courier New', Courier, monospace;">$db_slave_url['default'] = 'mysqli://user:password@slave-host/database';</span></code>
</div>
<h2>Comments</h2>
<div class='comments'>
    <div class='comment'>
        <div class='author'>Harriet Dakota</div>
        <div class='content'>
            I just came across from this article and I read it. It is too good and worth reading. And now I would like
            to say that thanks for sharing with me such nice article. Deciding upon a content management system is
            highly important long-term I advocate Drupal. Because Seeing that the leading nonprofits use Durpal, I
            picked Drupal For hosting I run Pantheon with features like automated back-up retention.. What Content
            Management System do you like?<br/><br/><a href="https://drupal.org/marketplace/pantheon-systems"
                                                       rel="nofollow">Drupal for Education</a><br/></div>
    </div>
    <div class='comment'>
        <div class='author'>nickg76571</div>
        <div class='content'>
            Hey, I was wondering about the load on the master/slave server are they distributed evenly for all the
            requests or ONLY when the master goes down slave gets activated. <br/><br/>I just have regular drupal for
            now. I am little skeptical about installing pressflow. In the future i believe my website would grow and
            want to handle the needs of any load. So do you think pressflow will be able to do that. In a way do they
            really split reads &amp; writes ?
        </div>
    </div>
</div>
